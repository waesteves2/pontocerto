<!DOCTYPE html>
<html lang="pt">
<title>Cartão de Ponto</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/pt-br.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.8/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>


<style>
  body {
    font-family: 'Courier New', Courier, monospace;
  }

  h1 {
    text-align: center;
  }

  #punch-in-out {
    text-align: center;
  }

  #punch-in-out input {
    margin-top: 10px;
  }

  #report {
    margin-top: 20px;
    text-align: center;
  }

  #report table {
    margin: 0 auto;
    border-collapse: collapse;
    font-size: small;


  }

  #report table th,
  #report table td {
    border: 1px solid #000;


  }

  #employee-id {
    padding: 10px;
    border-radius: 5px;
  }

  .checkmark {
    display: inline-block;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid #000;
    background-color: #2ecc71;
    animation: checkmark 3s linear;
  }

  @keyframes checkmark {
    0% {
      transform: scale(0);
      opacity: 0;
    }

    50% {
      transform: scale(1.2);
      opacity: 1;
    }

    100% {
      transform: scale(1);
      opacity: 0;
    }
  }

  #employee-report {
    text-align: center;
    font-size: 18px;

  }

  #reset-button {
    margin-top: 10px;
  }

  .checkmark-wrapper {
    position: fixed;
    top: 75%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    width: 15cm;
    height: 15cm;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  .checkmark-wrapper img {
    max-width: 30%;
    max-height: 70%;
  }

  .checkmark-wrapper span {
    font-size: 20px;
    margin-top: 10px;
  }

  .day-of-week {
    color: rgb(8, 8, 8);
  }

  button {
    padding: 10px 20px;
    background-color: #0984e3;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    font-family: 'Arial', sans-serif;
    font-size: 14px;
    cursor: pointer;
    margin-right: 10px;
  }

  #reset-button {
    background-color: #d63031;
  }

  #employee-select {
    width: 230px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 3px;
    padding: 8px;
  }

  #employee-report {
    padding: 10px;
  }

  #report {
    background-color: #f5f5f5;
    border-radius: 5px;
    box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);

  }

  .absent {
    background-color: #ffcccc;
    color: #d63031;
  }


  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
  }

  .close-button {
    position: absolute;
    top: 3px;
    font-size: 35px;
    cursor: pointer;
    color: #d63031;

  }

  .edit-table {
    border-collapse: collapse;
    width: 100%;
  }

  .edit-table th,
  .edit-table td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }

  .edit-table input:invalid {
    border: 1px solid red;
  }


  .day-of-week {
    color: red;
  }

  .blue-counter {
    color: #0984e3;

  }

  .clock {
    background-color: #0984e3;
    color: #fff;
    padding: 20px;
    border-radius: 10px;
    font-size: 2rem;
    width: 200px;
    margin:auto;
    text-align: center;
    font-family: Arial, sans-serif;
    align-items: center;

  }
</style>


</head>

<body>



  <div id="punch-in-out">
    <label for="employee-id">Código de Matrícula:</label><br>
    <input type="text" id="employee-id" autofocus onkeydown="registerPunch(event)">

  </div>
  <div id="report">
    <h2>Cartão de Ponto</h2>
    <select id="employee-select" onchange="generateReport()">
      <option value="">Selecione um colaborador</option>
      <option value="401">Welton Alves Esteves</option>
      <option value="002">Beatriz Fernanda Veratti</option>
      <option value="490">Deise Fernanda da Silva</option>
      <option value="496">Jéssica Freitas Sales</option>
      <option value="457">Mayara Fernanda Araujo</option>
      <option value="408">Priscila Aparecida de Castro</option>
      <option value="262">Renata Mariano de Andrade Tavares</option>
      <option value="430">Stephanie Paula Fortunato</option>
      <option value="195">Telma Cristina Rossanese</option>
      <option value="436">Amanda Pelegrin Dias</option>

    </select><br><br>
    <div id="employee-report"></div>
    <button onclick="generatePDF()">Gerar PDF</button>
    <button id="reset-button" onclick="confirmReset()">Resetar</button>
    <button onclick="exportToExcel()">Exportar para Excel</button>
    <button onclick="importFromExcel()">Importar de Excel</button>
  </div>


  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeEditModal()">&times;</span>
      <h2>Editar Horários</h2>
      <p>Data: <span id="edit-date"></span></p>
      <p>ID do funcionário: <span id="edit-employeeId"></span></p>
      <label>Entrada Manhã:</label><br>
      <input type="text" id="edit-entryMorning" /><br>
      <label>Saída Manhã:</label><br>
      <input type="text" id="edit-exitMorning" /><br>
      <label>Entrada Tarde:</label><br>
      <input type="text" id="edit-entryAfternoon" /><br>
      <label>Saída Tarde:</label><br>
      <input type="text" id="edit-exitAfternoon" /><br><br>
      <button onclick="saveEdit()">Salvar</button>
    </div>
  </div>

  <div id="checkmark-wrapper" class="checkmark-wrapper" style="display: none;">
    <img id="checkmark-image" src="https://imagepng.org/wp-content/uploads/2019/12/check-icone-3.png" alt="Checkmark">
    <span id="checkmark-text"></span>
  </div>
  <br>
  <br>
  <div class="clock" id="clock">
    00:00:00
  </div>

  <script>

    function getWeekdayName(dateString) {
      var weekdays = ['Domingo', '2ª feira', '3ª feira', '4ª feira', '5ª feira', '6ª feira', 'Sábado'];
      var date = moment(dateString, 'DD/MM/YYYY');
      var dayOfWeek = date.day();
      return weekdays[dayOfWeek];
    }


    var resetButton = document.getElementById("reset-button");

    function confirmReset() {
      var enteredPassword = prompt("Digite a senha");

      var correctPassword = "30410";

      if (enteredPassword === correctPassword) {
        var confirmation = confirm("Tem certeza de que deseja redefinir o sistema? Isso apagará todos os registros.");
        if (confirmation) {
          resetPunches();
        }
      } else {
        alert("Senha incorreta");
      }
    }


    function resetPunches() {
      punches = [];
      localStorage.removeItem("punches");
      generateReport();
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/pt-br.js"></script>
  <script>
    function buscarColaborador(codigo) {
      const colaboradores = {
        '401': {
          nome: 'Welton Alves Esteves',
          cpf: '401.260.068-06',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:50' },
            entradaTarde: { inicio: '13:00', fim: '15:00' },
            saidaTarde: { inicio: '16:00', fim: '22:30' },
          },
        },
        '002': {
          nome: 'Beatriz Fernanda Veratti',
          cpf: '222.222.222-22',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:20' },
            entradaTarde: { inicio: '13:00', fim: '15:00' },
            saidaTarde: { inicio: '17:00', fim: '20:00' },
          },
        },

        '490': {
          nome: 'Deise Fernanda da Silva',
          cpf: '490.017.218-93',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '12:50', fim: '14:00' },
            saidaTarde: { inicio: '16:00', fim: '20:00' },
          },
        },

        '496': {
          nome: 'Jéssica Freitas Sales',
          cpf: '496.349.448-50',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '13:00', fim: '15:00' },
            saidaTarde: { inicio: '16:00', fim: '21:00' },
          },
        },

        '457': {
          nome: 'Mayara Fernanda Araujo',
          cpf: '457.214.868-64',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:40' },
            entradaTarde: { inicio: '12:50', fim: '14:30' },
            saidaTarde: { inicio: '16:00', fim: '19:00' },
          },
        },

        '002': {
          nome: 'Beatriz Fernanda Veratti',
          cpf: '222.222.222-22',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:20' },
            entradaTarde: { inicio: '13:00', fim: '15:00' },
            saidaTarde: { inicio: '17:00', fim: '20:00' },
          },
        },

        '408': {
          nome: 'Priscila Aparecida de Castro',
          cpf: '408.059.348-12',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '12:50', fim: '14:00' },
            saidaTarde: { inicio: '16:00', fim: '19:00' },
          },
        },

        '262': {
          nome: 'Renata Mariano de Andrade Tavares',
          cpf: '262.080.898-60',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '12:50', fim: '14:00' },
            saidaTarde: { inicio: '16:00', fim: '19:00' },
          },
        },

        '430': {
          nome: 'Stephanie Paula Fortunato',
          cpf: '430.906.108-76',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '12:50', fim: '14:00' },
            saidaTarde: { inicio: '16:00', fim: '19:00' },
          },
        },

        '195': {
          nome: 'Telma Cristina Rossanese',
          cpf: '195.340.618-16',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '12:50', fim: '14:00' },
            saidaTarde: { inicio: '16:00', fim: '19:00' },
          },
        },

        '436': {
          nome: 'Amanda Pelegrin Dias',
          cpf: '436.861.648-09',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:30' },
            entradaTarde: { inicio: '12:50', fim: '14:00' },
            saidaTarde: { inicio: '16:00', fim: '19:00' },
          },
        },

      };

      return colaboradores[codigo];
    }

    var employees = [
      { id: "401", name: "Welton Alves Esteves", jornada: 8.48 },
      { id: "002", name: "Beatriz Fernanda Veratti", jornada: 8.48 },
      { id: "490", name: "Deise Fernanda da Silva", jornada: 8.48 },
      { id: "496", name: "Jéssica Freitas Sales", jornada: 8.48 },
      { id: "457", name: "Mayara Fernanda Araujo", jornada: 8.48 },
      { id: "408", name: "Priscila Aparecida de Castro", jornada: 8.48 },
      { id: "262", name: "Renata Mariano de Andrade Tavares", jornada: 8.48 },
      { id: "430", name: "Stephanie Paula Fortunato", jornada: 8.48 },
      { id: "195", name: "Telma Cristina Rossanese", jornada: 8.48 },
      { id: "436", name: "Amanda Pelegrin Dias", jornada: 8.48 },


    ];

    var punches = [];

    if (typeof Storage !== "undefined") {
      var punchesData = localStorage.getItem("punches");
      if (punchesData) {
        punches = JSON.parse(punchesData);
      }
    } else {
      alert("Seu navegador não suporta o recurso de Local Storage. Por favor, atualize-o.");
    }


    function registerPunch(event) {
      if (event.keyCode === 13) {
        event.preventDefault();

        var employeeId = document.getElementById("employee-id").value;
        var employee = getEmployeeById(employeeId);

        if (employee) {
          var currentDate = new Date();
          var date = currentDate.toLocaleDateString();
          var time = currentDate.toLocaleTimeString();

          var punchType = getPunchType(time, employeeId);
          var lastPunch = getLastPunch(employeeId);

          if (lastPunch && lastPunch.date === date) {
            if (punchType === lastPunch.punchType) {
              lastPunch.time = time;
            } else {
              punches.push({
                employeeId: employeeId,
                employeeName: employee.name,
                date: date,
                time: time,
                punchType: punchType,
              });
            }
          } else {
            punches.push({
              employeeId: employeeId,
              employeeName: employee.name,
              date: date,
              time: time,
              punchType: punchType,
            });

            var currentDayOfWeek = currentDate.getDay();
            var isWeekend = currentDayOfWeek === 0 || currentDayOfWeek === 6;


          }

          var updatedPunches = JSON.stringify(punches);
          localStorage.setItem("punches", updatedPunches);

          document.getElementById("employee-id").value = "";
          showCheckmark(employee.name);
          generateReport();
        } else {
          alert("Colaborador não encontrado. Verifique o código de matrícula digitado.");
        }
      }
    }


    function generateReport() {
      var employeeSelect = document.getElementById("employee-select");
      var selectedEmployeeId = employeeSelect.value;
      var employeeReport = document.getElementById("employee-report");
      employeeReport.innerHTML = "";

      if (selectedEmployeeId) {
        var punchesFiltered = punches.filter(function (punch) {
          return punch.employeeId === selectedEmployeeId;
        });

        var table = document.createElement("table");
        table.classList.add("report-table");

        var headerRow = document.createElement("tr");
        var headers = [
          "Data",
          "Dia da Semana",
          "Entrada Manhã",
          "Saída Manhã",
          "Entrada Tarde",
          "Saída Tarde",
          "Horas Trabalhadas",
          "Horas Extras",
          "Horas Ausentes",
        ];

        headers.forEach(function (headerText) {
          var headerCell = document.createElement("th");
          headerCell.textContent = headerText;
          headerRow.appendChild(headerCell);
        });

        table.appendChild(headerRow);

        var expectedWorkingHours = 8 * 3600 + 48 * 60;
        var totalRegularHours = 0;
        var totalExtraHours = 0;
        var totalAbsentHours = 0;
        var holidays = [
          "01/01/2023", // Confraternização Universal
          "07/04/2023", // Paixão de Cristo
          "21/04/2023", // Tiradentes
          "01/05/2023", // Dia Mundial do Trabalhador
          "08/06/2023", // Corpus Christi
          "09/07/2023", // Data Magna do Estado de São Paulo
          "07/09/2023", // Independência do Brasil
          "12/10/2023", // Nossa Senhora Aparecida
          "02/11/2023", // Finados
          "15/11/2023", // Proclamação da República
          "20/11/2023", // Dia da Consciência Negra
          "25/12/2023", // Natal
        ];

        var firstPunchDate = punchesFiltered.length > 0 ? punchesFiltered[0].date : null;
        var lastPunchDate = punchesFiltered.length > 0 ? punchesFiltered[punchesFiltered.length - 1].date : null;

        if (firstPunchDate && lastPunchDate) {
          var currentDate = moment(firstPunchDate, "DD/MM/YYYY");

          while (currentDate.isSameOrBefore(moment(lastPunchDate, "DD/MM/YYYY"))) {
            var row = document.createElement("tr");

            var dateCell = document.createElement("td");
            dateCell.textContent = currentDate.format("DD/MM/YYYY");
            row.appendChild(dateCell);

            var dayOfWeekCell = document.createElement("td");
            dayOfWeekCell.textContent = getWeekdayName(currentDate.format("DD/MM/YYYY"));
            row.appendChild(dayOfWeekCell);

            var entryMorningCell = document.createElement("td");
            var exitMorningCell = document.createElement("td");
            var entryAfternoonCell = document.createElement("td");
            var exitAfternoonCell = document.createElement("td");
            var totalHoursCell = document.createElement("td");
            var extraHoursCell = document.createElement("td");
            var absentHoursCell = document.createElement("td");
            var editCell = document.createElement("td");

            entryMorningCell.textContent = "-";
            exitMorningCell.textContent = "-";
            entryAfternoonCell.textContent = "-";
            exitAfternoonCell.textContent = "-";
            totalHoursCell.textContent = "-";
            extraHoursCell.textContent = "-";
            absentHoursCell.textContent = "-";
            editCell.textContent = "Editar";
            editCell.classList.add("edit-button");
            editCell.setAttribute("data-date", currentDate.format("DD/MM/YYYY"));
            editCell.setAttribute("data-employeeId", selectedEmployeeId);
            editCell.onclick = openEditModal;

            var morningEntry = punchesFiltered.find(function (punch) {
              return punch.date === currentDate.format("DD/MM/YYYY") && punch.punchType === "entrada_manha";
            });

            var morningExit = punchesFiltered.find(function (punch) {
              return punch.date === currentDate.format("DD/MM/YYYY") && punch.punchType === "saida_manha";
            });

            var afternoonEntry = punchesFiltered.find(function (punch) {
              return punch.date === currentDate.format("DD/MM/YYYY") && punch.punchType === "entrada_tarde";
            });

            var afternoonExit = punchesFiltered.find(function (punch) {
              return punch.date === currentDate.format("DD/MM/YYYY") && punch.punchType === "saida_tarde";
            });

            if (morningEntry) {
              entryMorningCell.textContent = morningEntry.time;
            }

            if (morningExit) {
              exitMorningCell.textContent = morningExit.time;
            }

            if (afternoonEntry) {
              entryAfternoonCell.textContent = afternoonEntry.time;
            }

            if (afternoonExit) {
              exitAfternoonCell.textContent = afternoonExit.time;
            }

            var totalMorningSeconds = 0;
            var totalAfternoonSeconds = 0;

            if (entryMorningCell.textContent !== "-" && exitMorningCell.textContent !== "-") {
              var morningEntryTime = moment(entryMorningCell.textContent, "HH:mm");
              var morningExitTime = moment(exitMorningCell.textContent, "HH:mm");
              totalMorningSeconds = morningExitTime.diff(morningEntryTime, "seconds");
            }

            if (entryAfternoonCell.textContent !== "-" && exitAfternoonCell.textContent !== "-") {
              var afternoonEntryTime = moment(entryAfternoonCell.textContent, "HH:mm");
              var afternoonExitTime = moment(exitAfternoonCell.textContent, "HH:mm");
              totalAfternoonSeconds = afternoonExitTime.diff(afternoonEntryTime, "seconds");
            }

            var totalSeconds = totalMorningSeconds + totalAfternoonSeconds;
            var extraSeconds = totalSeconds - expectedWorkingHours;
            var absentSeconds = expectedWorkingHours - totalSeconds;

            if (currentDate.day() === 0 || currentDate.day() === 6) {
              totalSeconds = 0;
              extraSeconds = 0;
            } else if (holidays.includes(currentDate.format("DD/MM/YYYY"))) {
              totalSeconds = 0;
              extraSeconds = 0;
            } else {
              totalRegularHours += totalSeconds > 0 ? totalSeconds : 0;
              totalExtraHours += extraSeconds > 0 ? extraSeconds : 0;
              totalAbsentHours += absentSeconds > 0 ? absentSeconds : 0;
            }

            totalHoursCell.textContent = secondsToTimeString(totalSeconds);
            extraHoursCell.textContent = extraSeconds > 0 ? secondsToTimeString(extraSeconds) : "00:00:00";

            if (holidays.includes(currentDate.format("DD/MM/YYYY"))) {
              absentHoursCell.textContent = "Feriado";
              editCell.disabled = true;
            } else if (currentDate.day() === 0 || currentDate.day() === 6) {
              absentHoursCell.textContent = "00:00:00";
            } else {
              absentHoursCell.textContent = absentSeconds > 0 ? secondsToTimeString(absentSeconds) : "00:00:00";
              absentHoursCell.classList.toggle("absent", absentSeconds > 0);
            }

            if (currentDate.day() === 0 || currentDate.day() === 6) {
              row.classList.add("day-of-week");
            }

            row.appendChild(dateCell);
            row.appendChild(dayOfWeekCell);
            row.appendChild(entryMorningCell);
            row.appendChild(exitMorningCell);
            row.appendChild(entryAfternoonCell);
            row.appendChild(exitAfternoonCell);
            row.appendChild(totalHoursCell);
            row.appendChild(extraHoursCell);
            row.appendChild(absentHoursCell);
            row.appendChild(editCell);
            table.appendChild(row);

            currentDate.add(1, "day");
          }

          var totalsRow = document.createElement("tr");
          totalsRow.classList.add("totals-row");

          var totalsLabelCell = document.createElement("td");
          totalsLabelCell.textContent = "Total:";
          totalsLabelCell.classList.add("blue-counter");
          totalsLabelCell.colSpan = 6;
          totalsRow.appendChild(totalsLabelCell);

          var totalRegularHoursCell = document.createElement("td");
          totalRegularHoursCell.textContent = secondsToTimeString(totalRegularHours);
          totalRegularHoursCell.classList.add("blue-counter");
          totalsRow.appendChild(totalRegularHoursCell);

          var totalExtraHoursCell = document.createElement("td");
          totalExtraHoursCell.textContent = secondsToTimeString(totalExtraHours);
          totalExtraHoursCell.classList.add("blue-counter");
          totalsRow.appendChild(totalExtraHoursCell);

          var totalAbsentHoursCell = document.createElement("td");
          totalAbsentHoursCell.textContent = secondsToTimeString(totalAbsentHours);
          totalAbsentHoursCell.classList.add("blue-counter");
          totalsRow.appendChild(totalAbsentHoursCell);

          table.appendChild(totalsRow);
        }

        employeeReport.appendChild(table);
        console.log("punchesFiltered array:", punchesFiltered);

        

        

      }
    }

    


    function secondsToTimeString(totalSeconds) {
      var hours = Math.floor(totalSeconds / 3600);
      var minutes = Math.floor((totalSeconds % 3600) / 60);
      var seconds = totalSeconds % 60;
      return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    
    function getEmployeeById(employeeId) {
      return employees.find(function (employee) {
        return employee.id === employeeId;
      });
    }
    function getPunchType(time, employeeId) {
      var employee = buscarColaborador(employeeId);
      var horarios = employee.horarios;

      if (time >= horarios.entradaManha.inicio && time <= horarios.entradaManha.fim) {
        return "entrada_manha";
      } else if (time >= horarios.saidaManha.inicio && time <= horarios.saidaManha.fim) {
        return "saida_manha";
      } else if (time >= horarios.entradaTarde.inicio && time <= horarios.entradaTarde.fim) {
        return "entrada_tarde";
      } else if (time >= horarios.saidaTarde.inicio && time <= horarios.saidaTarde.fim) {
        return "saida_tarde";
      } else if (time > horarios.saidaTarde.fim && time < horarios.entradaTarde.inicio) {
        return "extra";
      } else {
        return "horas_trabalhadas";
      }
    }


    function getLastPunch(employeeId) {
      var punchesFiltered = punches.filter(function (punch) {
        return punch.employeeId === employeeId;
      });

      if (punchesFiltered.length > 0) {
        return punchesFiltered[punchesFiltered.length - 1];
      } else {
        return null;
      }
    }

    function showCheckmark(employeeName) {
      var checkmarkWrapper = document.getElementById("checkmark-wrapper");
      var checkmarkImage = document.getElementById("checkmark-image");
      var checkmarkText = document.getElementById("checkmark-text");

      checkmarkText.innerText = employeeName;
      checkmarkWrapper.style.display = "flex";

      setTimeout(function () {
        checkmarkWrapper.style.display = "none";
      }, 3000);
    }


    function addInfoToPDF(tempContainer) {
      var logoImg = document.createElement("img");
      logoImg.src = "./Logo Rosseto.jpg";
      logoImg.width = 180;
      tempContainer.appendChild(logoImg);

      var companyName = document.createElement("h2");
      companyName.innerText = "Rosseto & Araujo Transportes LTDA ME";
      companyName.style.textAlign = "center";
      companyName.style.fontSize = "18px";
      companyName.style.fontFamily = "Calibri, Arial, sans-serif";

      tempContainer.appendChild(companyName);

      var cnpj = document.createElement("h3");
      cnpj.innerText = "CNPJ: 08.712.160/0001-75";
      cnpj.style.fontSize = "15px";
      cnpj.style.fontFamily = "Calibri, Arial, sans-serif";

      tempContainer.appendChild(cnpj);
    }

    function addEmployeeInfoToPDF(tempContainer, colaborador) {
      var signatureLine = document.createElement("p");
      signatureLine.innerText = "______________________________";
      signatureLine.style.marginTop = "50px"
      tempContainer.appendChild(signatureLine);

      var employeeName = document.createElement("h3");
      employeeName.innerText = ` ${colaborador.nome}`;
      employeeName.style.fontSize = "15.5px"
      employeeName.style.fontFamily = "Calibri, Arial, sans-serif"
      tempContainer.appendChild(employeeName);

      var cpf = document.createElement("h3");
      cpf.innerText = `CPF:${colaborador.cpf}`;
      cpf.style.fontSize = "15.5px"
      cpf.style.fontFamily = "Calibri, Arial, sans-serif"
      tempContainer.appendChild(cpf);
    }

    function generatePDF() {
      var editButtons = document.getElementsByClassName("edit-button");
      for (var i = 0; i < editButtons.length; i++) {
        editButtons[i].style.display = "none";
      }

      const selectedEmployeeId = document.getElementById("employee-select").value;

      if (selectedEmployeeId) {
        const employeeInfo = buscarColaborador(selectedEmployeeId);
        if (employeeInfo) {
          const opt = {
            margin: 10,
            filename: `.${employeeInfo.nome}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };

          var tempContainer = document.createElement("div");

          addInfoToPDF(tempContainer);

          var reportContainer = document.getElementById("employee-report");
          if (reportContainer) {
            var reportContent = document.createElement("h3");
            reportContent.innerHTML = reportContainer.innerHTML;
            reportContent.style.fontSize = "14px";
            reportContent.style.textAlign = "center";
            reportContent.style.fontFamily = "Calibri, Arial, sans-serif";
            tempContainer.appendChild(reportContent);
          } else {
            alert("A div 'employee-report' não foi encontrada.");
            return;
          }

          var currentDate = getFormattedDate();

          var monthYear = document.createElement("h3");
          monthYear.innerText = "Mês " + currentDate;
          monthYear.style.position = "absolute";
          monthYear.style.top = "10mm";
          monthYear.style.right = "10mm";
          monthYear.style.fontSize = "14px";
          monthYear.style.fontFamily = "Calibri, Arial, sans-serif";
          tempContainer.appendChild(monthYear);

          html2pdf().from(tempContainer).set(opt).then(function () {
            addEmployeeInfoToPDF(tempContainer, employeeInfo);

            html2pdf().from(tempContainer).set(opt).save();

            setTimeout(function () {
              var editButtons = document.getElementsByClassName("edit-button");
              for (var i = 0; i < editButtons.length; i++) {
                editButtons[i].style.display = "table-cell";
              }
            }, 100);
          });
        }
      }
    }

    function getFormattedDate() {
      var date = new Date();
      var month = (date.getMonth() + 1).toString().padStart(2, "0");
      var year = date.getFullYear().toString();
      return `${month}/${year}`;
    }

    function openEditModal(event) {
      var date = event.target.getAttribute("data-date");
      var employeeId = event.target.getAttribute("data-employeeId");

      document.getElementById("edit-date").textContent = date;
      document.getElementById("edit-employeeId").textContent = employeeId;

      var punchesFiltered = punches.filter(function (punch) {
        return punch.date === date && punch.employeeId === employeeId;
      });

      var entryMorning = punchesFiltered.find(function (punch) {
        return punch.punchType === "entrada_manha";
      });

      var exitMorning = punchesFiltered.find(function (punch) {
        return punch.punchType === "saida_manha";
      });

      var entryAfternoon = punchesFiltered.find(function (punch) {
        return punch.punchType === "entrada_tarde";
      });

      var exitAfternoon = punchesFiltered.find(function (punch) {
        return punch.punchType === "saida_tarde";
      });

      document.getElementById("edit-entryMorning").value = entryMorning ? entryMorning.time : "";
      document.getElementById("edit-exitMorning").value = exitMorning ? exitMorning.time : "";
      document.getElementById("edit-entryAfternoon").value = entryAfternoon ? entryAfternoon.time : "";
      document.getElementById("edit-exitAfternoon").value = exitAfternoon ? exitAfternoon.time : "";

      var modal = document.getElementById("edit-modal");
      modal.style.display = "block";

      
    }

    function closeEditModal() {
      var modal = document.getElementById("edit-modal");
      modal.style.display = "none";
    }

    function saveEdit() {
  var date = document.getElementById("edit-date").textContent;
  var employeeId = document.getElementById("edit-employeeId").textContent;
  var entryMorning = document.getElementById("edit-entryMorning").value;
  var exitMorning = document.getElementById("edit-exitMorning").value;
  var entryAfternoon = document.getElementById("edit-entryAfternoon").value;
  var exitAfternoon = document.getElementById("edit-exitAfternoon").value;

  var enteredPassword = prompt("Digite sua senha:");
  var correctPassword = "30410";

  console.log("Captured date:", date);
console.log("Captured employeeId:", employeeId);

  if (enteredPassword === correctPassword) {
    var punchUpdated = false; // Variable to track whether a punch was updated

    punches.forEach(function (punch) {
      if (punch.date === date && punch.employeeId === employeeId) {
        if (punch.punchType === "entrada_manha") {
          punch.time = entryMorning !== "" ? entryMorning : "";
        } else if (punch.punchType === "saida_manha") {
          punch.time = exitMorning !== "" ? exitMorning : "";
        } else if (punch.punchType === "entrada_tarde") {
          punch.time = entryAfternoon !== "" ? entryAfternoon : "";
        } else if (punch.punchType === "saida_tarde") {
          punch.time = exitAfternoon !== "" ? exitAfternoon : "";
        }

        punchUpdated = true; // Mark that a punch was updated
      }
    });

    // If no punch was updated, create a new punch
    if (!punchUpdated) {
      punches.push({
        employeeId: employeeId,
        date: date,
        time: entryMorning !== "" ? entryMorning : exitMorning !== "" ? exitMorning : entryAfternoon !== "" ? entryAfternoon : exitAfternoon,
        // You might need to set the appropriate punchType here based on the cell edited
      });
    }

    localStorage.setItem("punches", JSON.stringify(punches));

    console.log("Updated punches array:", punches);


    closeEditModal();

    generateReport();
  } else {
    alert("Senha Incorreta");
  }
}

    


    function registerAutoPunch() {
      var today = new Date();
      var dayOfWeek = today.getDay();

      if (dayOfWeek === 0) {
        showCheckmark("Domingo");
        registerNonWorkingDay("Domingo");
        generateReport();
      } else if (dayOfWeek === 6) {
        showCheckmark("Sábado");
        registerNonWorkingDay("Sábado");
        generateReport();
      } else {
        var employeeSelect = document.getElementById("employee-select");
        var selectedEmployeeId = employeeSelect.value;

        if (selectedEmployeeId) {
          var employee = getEmployeeById(selectedEmployeeId);
          if (employee) {
            var date = today.toLocaleDateString();
            var time = today.toLocaleTimeString();

            var punchType = getPunchType(time, selectedEmployeeId);
            var lastPunch = getLastPunch(selectedEmployeeId);

            if (!lastPunch || lastPunch.date !== date || lastPunch.punchType !== punchType) {
              punches.push({
                employeeId: selectedEmployeeId,
                employeeName: employee.name,
                date: date,
                time: time,
                punchType: punchType
              });

              localStorage.setItem("punches", JSON.stringify(punches));
              showCheckmark(employee.name);
              generateReport();
            }
          }
        }
      }
    }

    function registerNonWorkingDay(dayOfWeek) {
      var employeeSelect = document.getElementById("employee-select");
      var selectedEmployeeId = employeeSelect.value;

      if (selectedEmployeeId) {
        var employee = getEmployeeById(selectedEmployeeId);
        if (employee) {
          var date = new Date().toLocaleDateString();
          var punchesToday = punches.filter(p => p.employeeId === selectedEmployeeId && p.date === date);

          if (punchesToday.length === 0) {
            punches.push({
              employeeId: selectedEmployeeId,
              employeeName: employee.name,
              date: date,
              time: "00:00",
              punchType: dayOfWeek
            });

            localStorage.setItem("punches", JSON.stringify(punches));
          }
        }
      }
    }



    var diasFalta = [];

    function adicionarDiasFalta(selectedEmployeeId) {
      var currentDate = moment();
      var punchesFiltered = punches.filter(function (punch) {
        return punch.employeeId === selectedEmployeeId;
      });

      diasFalta.forEach(function (dataFalta) {
        if (!punchesFiltered.some(function (punch) {
          return punch.date === dataFalta;
        })) {
          var row = document.createElement("tr");
          var dateCell = document.createElement("td");
          dateCell.textContent = moment(dataFalta, "DD/MM/YYYY").format("DD/MM/YY");
          row.appendChild(dateCell);

          var employeeReport = document.getElementById("employee-report");
          employeeReport.appendChild(row);
        }
      });

      diasFalta = [];
    }

    function registrarPonto() {
      var selectedEmployeeId = document.getElementById("employee-select").value;

      if (diasFalta.length > 0) {
        adicionarDiasFalta(selectedEmployeeId);
      }

      var currentDate = moment();
      var currentDateFormatted = currentDate.format("DD/MM/YYYY");

      var yesterdayDate = currentDate.clone().subtract(1, "day");
      var yesterdayDateFormatted = yesterdayDate.format("DD/MM/YYYY");

      var punchesFiltered = punches.filter(function (punch) {
        return punch.employeeId === selectedEmployeeId;
      });

      var hasPunchToday = punchesFiltered.some(function (punch) {
        return punch.date === currentDateFormatted;
      });

      var hasPunchYesterday = punchesFiltered.some(function (punch) {
        return punch.date === yesterdayDateFormatted;
      });

      if (!hasPunchToday && hasPunchYesterday) {
        punches.push({
          employeeId: selectedEmployeeId,
          employeeName: getEmployeeById(selectedEmployeeId).name,
          date: currentDateFormatted,
          time: "00:00:00",
          punchType: "falta"
        });

        localStorage.setItem("punches", JSON.stringify(punches));

        marcarFalta(currentDateFormatted);
      }

      var employeeReturned = diasFalta.indexOf(currentDateFormatted);
      if (employeeReturned !== -1) {
        diasFalta.splice(employeeReturned, 1);
      }
    }




    function exportToExcel() {
      var workbook = XLSX.utils.book_new();
      var punchesSheet = XLSX.utils.json_to_sheet(punches);
      XLSX.utils.book_append_sheet(workbook, punchesSheet, "Registro de Ponto");

      var currentDate = new Date();
      var day = currentDate.getDate();
      var month = currentDate.getMonth() + 1;
      var year = currentDate.getFullYear();
      var formattedDate = day + "-" + month + "-" + year;
      var exportFileName = "backup_" + formattedDate + ".xlsx";

      XLSX.writeFile(workbook, exportFileName);
    }

    function importFromExcel() {
      var input = document.createElement("input");
      input.type = "file";
      input.accept = ".xls, .xlsx";
      input.onchange = function (e) {
        var file = e.target.files[0];

        if (!file) {
          alert("Nenhum arquivo selecionado.");
          return;
        }

        var reader = new FileReader();

        reader.onload = function (e) {
          try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: "array" });
            var punchesSheet = workbook.Sheets[workbook.SheetNames[0]];
            var punchesData = XLSX.utils.sheet_to_json(punchesSheet, { raw: false });

            if (confirm("Tem certeza de que deseja importar os novos dados? Isso substituirá os dados existentes.")) {
              punches = punchesData;
              localStorage.setItem("punches", JSON.stringify(punches));

              generateReport();

              alert("Dados importados com sucesso!");
            }
          } catch (error) {
            alert("Erro ao importar o arquivo. Verifique se o formato está correto.");
          }
        };

        reader.readAsArrayBuffer(file);
      };

      input.click();
    }

    function scheduleExport() {
      var targetHour = 20;
      var targetMinute = 45;

      var exportInterval = setInterval(function () {
        var now = new Date();
        var currentHour = now.getHours();
        var currentMinute = now.getMinutes();

        if (currentHour === targetHour && currentMinute === targetMinute) {
          exportToExcel();
        }
      }, 60000);

      scheduleExport();

    }
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');

      const timeString = `${hours}:${minutes}:${seconds}`;
      document.getElementById('clock').textContent = timeString;
    }

    setInterval(updateClock, 1000);

    updateClock();


    


  </script>





</body>

</html>
